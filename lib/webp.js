"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=exports.constants=void 0;var _fs2=_interopRequireDefault(require("fs")),_util=require("util"),_path=require("path");function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function asyncGeneratorStep(gen,resolve,reject,_next,_throw,key,arg){try{var info=gen[key](arg),value=info.value}catch(error){return void reject(error)}info.done?resolve(value):Promise.resolve(value).then(_next,_throw)}function _asyncToGenerator(fn){return function(){var self=this,args=arguments;return new Promise((function(resolve,reject){var gen=fn.apply(self,args);function _next(value){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"next",value)}function _throw(err){asyncGeneratorStep(gen,resolve,reject,_next,_throw,"throw",err)}_next(void 0)}))}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _classPrivateMethodGet(receiver,privateSet,fn){if(!privateSet.has(receiver))throw new TypeError("attempted to get private field on non-instance");return fn}const fs={read:(0,_util.promisify)(_fs2.default.read),write:(0,_util.promisify)(_fs2.default.write),open:(0,_util.promisify)(_fs2.default.open),close:(0,_util.promisify)(_fs2.default.close)},nullByte=Buffer.alloc(1);nullByte[0]=0;const constants={TYPE_LOSSY:0,TYPE_LOSSLESS:1,TYPE_EXTENDED:2};function VP8Width(data){return 16383&(data[7]<<8|data[6])}function VP8Height(data){return 16383&(data[9]<<8|data[8])}function VP8LWidth(data){return 1+(16383&(data[2]<<8|data[1]))}function VP8LHeight(data){let n=data[4]<<16|data[3]<<8|data[2];return n>>=6,1+(16383&n)}function doesVP8LHaveAlpha(data){return!!(16&data[4])}function createBasicChunk(name,data){let out,chunk=Buffer.alloc(8),size=data.length;return chunk.write(name,0),chunk.writeUInt32LE(size,4),out=[chunk,data],1&size&&(out[2]=nullByte),out}exports.constants=constants;var _convertToExtended=new WeakSet,_demuxFrame=new WeakSet,_readHeader=new WeakSet,_readChunkHeader=new WeakSet,_readChunkHeader_buf=new WeakSet,_readChunk_raw=new WeakSet,_readChunk_VP=new WeakSet,_readChunk_VP8_buf=new WeakSet,_readChunk_VP8L=new WeakSet,_readChunk_VP8L_buf=new WeakSet,_readChunk_VP8X=new WeakSet,_readChunk_ANIM=new WeakSet,_readChunk_ANMF=new WeakSet,_readChunk_ALPH=new WeakSet,_readChunk_ALPH_buf=new WeakSet,_readChunk_ICCP=new WeakSet,_readChunk_EXIF=new WeakSet,_readChunk_XMP=new WeakSet,_readChunk_Skip=new WeakSet,_read=new WeakSet;class Image{constructor(){_read.add(this),_readChunk_Skip.add(this),_readChunk_XMP.add(this),_readChunk_EXIF.add(this),_readChunk_ICCP.add(this),_readChunk_ALPH_buf.add(this),_readChunk_ALPH.add(this),_readChunk_ANMF.add(this),_readChunk_ANIM.add(this),_readChunk_VP8X.add(this),_readChunk_VP8L_buf.add(this),_readChunk_VP8L.add(this),_readChunk_VP8_buf.add(this),_readChunk_VP.add(this),_readChunk_raw.add(this),_readChunkHeader_buf.add(this),_readChunkHeader.add(this),_readHeader.add(this),_demuxFrame.add(this),_convertToExtended.add(this),_defineProperty(this,"data",null),_defineProperty(this,"loaded",!1),_defineProperty(this,"path","")}clear(){this.data=null,this.path="",this.loaded=!1}get width(){if(!this.loaded)return;let d=this.data;return d.extended?d.extended.width:d.vp8l?d.vp8l.width:d.vp8?d.vp8.width:void 0}get height(){if(!this.loaded)return;let d=this.data;return d.extended?d.extended.height:d.vp8l?d.vp8l.height:d.vp8?d.vp8.height:void 0}get type(){return this.loaded?this.data.type:void 0}get hasAnim(){return!!this.loaded&&(!!this.data.extended&&this.data.extended.hasAnim)}get anim(){return this.hasAnim?this.data.anim:void 0}get frameCount(){return this.anim?this.anim.frameCount:0}get iccp(){return this.data.extended&&this.data.extended.hasICCP?this.data.iccp.raw:void 0}set iccp(raw){this.data.extended||_classPrivateMethodGet(this,_convertToExtended,_convertToExtended2).call(this),void 0===raw?(this.data.extended.hasICCP=!1,delete this.data.iccp):(this.data.iccp={raw:raw},this.data.extended.hasICCP=!0)}get exif(){return this.data.extended&&this.data.extended.hasEXIF?this.data.exif.raw:void 0}set exif(raw){this.data.extended||_classPrivateMethodGet(this,_convertToExtended,_convertToExtended2).call(this),void 0===raw?(this.data.extended.hasEXIF=!1,delete this.data.exif):(this.data.exif={raw:raw},this.data.extended.hasEXIF=!0)}get xmp(){return this.data.extended&&this.data.extended.hasXMP?this.data.xmp.raw:void 0}set xmp(raw){this.data.extended||_classPrivateMethodGet(this,_convertToExtended,_convertToExtended2).call(this),void 0===raw?(this.data.extended.hasXMP=!1,delete this.data.xmp):(this.data.xmp={raw:raw},this.data.extended.hasXMP=!0)}load(path){var _this=this;return _asyncToGenerator((function*(){_this.path=path,_this.data=yield _classPrivateMethodGet(_this,_read,_read2).call(_this,path),_this.loaded=!0}))()}demuxAnim(path,frame=-1,prefix="#FNAME#"){var _this2=this;return _asyncToGenerator((function*(){let start=0,end=_this2.frameCount;if(0==end)throw new Error("This WebP isn't an animation");-1!=frame&&(start=end=frame);for(let i=start;i<=end;i++)yield _classPrivateMethodGet(_this2,_demuxFrame,_demuxFrame2).call(_this2,`${path}/${prefix}_${i}.webp`.replace(/#FNAME#/g,(0,_path.basename)(_this2.path,".webp")),_this2.anim.frames[i])}))()}replaceFrame(path,frame){var _this3=this;return _asyncToGenerator((function*(){if(!_this3.hasAnim)throw new Error("WebP isn't animated");if(frame<0||frame>=_this3.frameCount)throw new Error(`Frame index ${frame} out of bounds (0<=index<${_this3.frameCount})`);let r=new Image;switch(yield r.load(path),r.type){case constants.TYPE_LOSSY:case constants.TYPE_LOSSLESS:break;case constants.TYPE_EXTENDED:if(r.hasAnim)throw new Error("Merging animations not currently supported");break;default:throw new Error("Unknown WebP type")}switch(_this3.anim.frames[frame].type){case constants.TYPE_LOSSY:_this3.anim.frames[frame].vp8.alpha&&delete _this3.anim.frames[frame].alph,delete _this3.anim.frames[frame].vp8;break;case constants.TYPE_LOSSLESS:delete _this3.anim.frames[frame].vp8l;break;default:throw new Error("Unknown frame type")}switch(r.type){case constants.TYPE_LOSSY:_this3.anim.frames[frame].vp8=r.data.vp8;break;case constants.TYPE_LOSSLESS:_this3.anim.frames[frame].vp8l=r.data.vp8l;break;case constants.TYPE_EXTENDED:r.data.vp8?(_this3.anim.frames[frame].vp8=r.data.vp8,r.data.vp8.alpha&&(_this3.anim.frames[frame].alph=r.data.alph)):r.data.vp8l&&(_this3.anim.frames[frame].vp8l=r.data.vp8l)}_this3.anim.frames[frame].width=r.width,_this3.anim.frames[frame].height=r.height}))()}muxAnim({path:path,bgColor:bgColor=[255,255,255,255],loops:loops=0}={}){var _this4=this;return _asyncToGenerator((function*(){return Image.muxAnim({path:path,bgColor:bgColor,loops:loops,frames:_this4.frames})}))()}static muxAnim({path:path,frames:frames,width:width=0,height:height=0,bgColor:bgColor=[255,255,255,255],loops:loops=0,delay:delay=100,x:x=0,y:y=0,blend:blend=!0,dispose:dispose=!1}={}){return _asyncToGenerator((function*(){let img,size,header=Buffer.alloc(12),chunk=Buffer.alloc(18),out=[],alpha=!1,_w=0,_h=0,_width=width-1,_height=height-1;if(0==frames.length)throw new Error("No frames to mux");if(_width<=0||_width>1<<24)throw new Error("Width out of range");if(_height<=0||_height>1<<24)throw new Error("Height out of range");if(_height*_width>Math.pow(2,32)-1)throw new Error(`Width*height too large (${_width}, ${_height})`);if(loops<0||loops>=1<<24)throw new Error("Loops out of range");if(delay<0||delay>=1<<24)throw new Error("Delay out of range");if(x<0||x>=1<<24)throw new Error("X out of range");if(y<0||y>=1<<24)throw new Error("Y out of range");header.write("RIFF",0),header.write("WEBP",8),chunk.write("VP8X",0),chunk.writeUInt32LE(10,4),chunk[8]|=2,0!=width&&chunk.writeUIntLE(_width,12,3),0!=height&&chunk.writeUIntLE(_height,15,3),out.push(header,chunk),chunk=Buffer.alloc(14),chunk.write("ANIM",0),chunk.writeUInt32LE(6,4),chunk.writeUInt8(bgColor[2],8),chunk.writeUInt8(bgColor[1],9),chunk.writeUInt8(bgColor[0],10),chunk.writeUInt8(bgColor[3],11),chunk.writeUInt16LE(loops,12),out.push(chunk);for(let i=0,l=frames.length;i<l;i++){let imgData,_delay=void 0===frames[i].delay?delay:frames[i].delay,_x=void 0===frames[i].x?x:frames[i].x,_y=void 0===frames[i].y?y:frames[i].y,_blend=void 0===frames[i].blend?blend:frames[i].blend,_dispose=void 0===frames[i].dispose?dispose:frames[i].dispose,size=16,keepChunk=!0;if(delay<0||delay>=1<<24)throw new Error(`Delay out of range on frame ${i}`);if(x<0||x>=1<<24)throw new Error(`X out of range on frame ${i}`);if(y<0||y>=1<<24)throw new Error(`Y out of range on frame ${i}`);switch(chunk=Buffer.alloc(24),chunk.write("ANMF",0),chunk.writeUIntLE(_x,8,3),chunk.writeUIntLE(_y,11,3),chunk.writeUIntLE(_delay,20,3),_blend||(chunk[23]|=2),_dispose&&(chunk[23]|=1),frames[i].path?(img=new Image,yield img.load(frames[i].path)):img={data:frames[i]},chunk.writeUIntLE(img.data.width-1,14,3),chunk.writeUIntLE(img.data.height-1,17,3),img.data.type){case constants.TYPE_LOSSY:{let c=img.data.vp8;_w=c.width>_w?c.width:_w,_h=c.height>_h?c.height:_h,size+=c.raw.length+8,imgData=createBasicChunk("VP8 ",c.raw)}break;case constants.TYPE_LOSSLESS:{let c=img.data.vp8l;_w=c.width>_w?c.width:_w,_h=c.height>_h?c.height:_h,size+=c.raw.length+8,c.alpha&&(alpha=!0),imgData=createBasicChunk("VP8L",c.raw)}break;case constants.TYPE_EXTENDED:if(img.data.extended.hasAnim){let fr=img.data.anim.frames;keepChunk=!1,img.data.extended.hasAlpha&&(alpha=!0);for(let i=0,l=fr.length;i<l;i++){_w=fr[i].width+_x>_w?fr[i].width+_x:_w,_h=fr[i].height+_y>_h?fr[i].height+_y:_h;let b=Buffer.alloc(8);b.write("ANMF",0),b.writeUInt32LE(fr[i].raw.length,4),out.push(b,fr[i].raw),1&fr[i].raw.length&&out.push(nullByte),b=fr[i].raw,b.writeUIntLE(_x,0,3),b.writeUIntLE(_y,3,3),b.writeUIntLE(_delay,12,3),_blend?b[15]&=253:b[15]|=2,_dispose?b[15]|=1:b[15]&=254}}else _w=img.data.extended.width>_w?img.data.extended.width:_w,_h=img.data.extended.height>_h?img.data.extended.height:_h,img.data.vp8?(imgData=[],img.data.alph&&(alpha=!0,imgData.push(...createBasicChunk("ALPH",img.data.alph.raw)),size+=img.data.alph.raw.length+8),imgData.push(...createBasicChunk("VP8 ",img.data.vp8.raw)),size+=img.data.vp8.raw.length+8):img.data.vp8l&&(imgData=createBasicChunk("VP8L",img.data.vp8l.raw),img.data.vp8l.alpha&&(alpha=!0),size+=img.data.vp8l.raw.length+8);break;default:throw new Error("Unknown image type")}keepChunk&&(chunk.writeUInt32LE(size,4),out.push(chunk,...imgData))}0==width&&out[1].writeUIntLE(_w-1,12,3),0==height&&out[1].writeUIntLE(_h-1,15,3),size=4;for(let i=1,l=out.length;i<l;i++)size+=out[i].length;header.writeUInt32LE(size,4),alpha&&(out[1][8]|=16);let fp=yield fs.open(path,"w");for(let i=0,l=out.length;i<l;i++)yield fs.write(fp,out[i],0,void 0,void 0);yield fs.close(fp)}))()}}var _convertToExtended2=function(){if(!this.loaded)throw new Error("No image loaded");this.data.type=constants.TYPE_EXTENDED,this.data.extended={hasICC:!1,hasAlpha:!1,hasEXIF:!1,hasXMP:!1,width:this.vp8?this.vp8.width:this.vp8l?this.vp8l.width:1,height:this.vp8?this.vp8.height:this.vp8l?this.vp8l.height:1}},_demuxFrame2=function(){var _demuxFrame3=_asyncToGenerator((function*(path,frame){let size,chunk,header=Buffer.alloc(12),out=[];if(header.write("RIFF",0),header.write("WEBP",8),out.push(header),(this.data.extended.hasICC||this.data.extended.hasEXIF||this.data.extended.hasXMP||frame.vp8&&frame.vp8.alpha)&&(chunk=Buffer.alloc(18),chunk.write("VP8X",0),chunk.writeUInt32LE(10,4),this.data.extended.hasICC&&(chunk[8]|=32),(frame.vp8l&&frame.vp8l.alpha||frame.vp8&&frame.vp8.alpha)&&(chunk[8]|=16),this.data.extended.hasEXIF&&(chunk[8]|=8),this.data.extended.hasXMP&&(chunk[8]|=4),chunk.writeUIntLE(frame.width-1,12,3),chunk.writeUIntLE(frame.height-1,15,3),out.push(chunk),this.data.extended.hasICC&&out.push(...createBasicChunk("ICCP",this.data.extended.icc.raw))),frame.vp8l)out.push(...createBasicChunk("VP8L",frame.vp8l.raw));else{if(!frame.vp8)throw new Error("Frame has no VP8/VP8L?");frame.vp8.alpha&&out.push(...createBasicChunk("ALPH",frame.alph.raw)),out.push(...createBasicChunk("VP8 ",frame.vp8.raw))}this.type==constants.TYPE_EXTENDED&&(this.data.extended.hasEXIF&&out.push(...createBasicChunk("EXIF",this.data.extended.exif.raw)),this.data.extended.hasXMP&&out.push(...createBasicChunk("XMP ",this.data.extended.xmp.raw))),size=4;for(let i=1,l=out.length;i<l;i++)size+=out[i].length;header.writeUInt32LE(size,4);let fp=yield fs.open(path,"w");for(let i=0,l=out.length;i<l;i++)yield fs.write(fp,out[i],0,void 0,void 0);yield fs.close(fp)}));return function(_x2,_x3){return _demuxFrame3.apply(this,arguments)}}(),_readHeader2=function(){var _readHeader3=_asyncToGenerator((function*(fd){let buf=Buffer.alloc(12),{bytesRead:bytesRead}=yield fs.read(fd,buf,0,12,void 0);if(12!=bytesRead)throw new Error("Reached end of file while reading header");if("RIFF"!=buf.toString("utf8",0,4))throw new Error("Bad header (not RIFF)");if("WEBP"!=buf.toString("utf8",8,12))throw new Error("Bad header (not WEBP)");return{fileSize:buf.readUInt32LE(4)}}));return function(_x4){return _readHeader3.apply(this,arguments)}}(),_readChunkHeader2=function(){var _readChunkHeader3=_asyncToGenerator((function*(fd){let buf=Buffer.alloc(8),{bytesRead:bytesRead}=yield fs.read(fd,buf,0,8,void 0);if(0==bytesRead)return{fourCC:"\0\0\0\0",size:0};if(bytesRead<8)throw new Error("Reached end of file while reading chunk header");return{fourCC:buf.toString("utf8",0,4),size:buf.readUInt32LE(4)}}));return function(_x5){return _readChunkHeader3.apply(this,arguments)}}(),_readChunkHeader_buf2=function(buf,cursor){return cursor>=buf.length?{fourCC:"\0\0\0\0",size:0}:{fourCC:buf.toString("utf8",cursor,cursor+4),size:buf.readUInt32LE(cursor+4)}},_readChunk_raw2=function(){var _readChunk_raw3=_asyncToGenerator((function*(n,fd,size){let buf=Buffer.alloc(size),discard=Buffer.alloc(1),{bytesRead:bytesRead}=yield fs.read(fd,buf,0,size,void 0);if(bytesRead!=size)throw new Error(`Reached end of file while reading ${n} chunk`);return 1&size&&(yield fs.read(fd,discard,0,1,void 0)),{raw:buf}}));return function(_x6,_x7,_x8){return _readChunk_raw3.apply(this,arguments)}}(),_readChunk_VP2=function(){var _readChunk_VP3=_asyncToGenerator((function*(fd,size){let buf=Buffer.alloc(size),discard=Buffer.alloc(1),{bytesRead:bytesRead}=yield fs.read(fd,buf,0,size,void 0);if(bytesRead!=size)throw new Error("Reached end of file while reading VP8 chunk");return 1&size&&(yield fs.read(fd,discard,0,1,void 0)),{raw:buf,width:VP8Width(buf,8),height:VP8Height(buf,8)}}));return function(_x9,_x10){return _readChunk_VP3.apply(this,arguments)}}(),_readChunk_VP8_buf2=function(buf,size,cursor){if(cursor>=buf.length)throw new Error("Reached end of buffer while reading VP8 chunk");let raw=buf.slice(cursor,cursor+size);return{raw:raw,width:VP8Width(raw),height:VP8Height(raw)}},_readChunk_VP8L2=function(){var _readChunk_VP8L3=_asyncToGenerator((function*(fd,size){let buf=Buffer.alloc(size),discard=Buffer.alloc(1),{bytesRead:bytesRead}=yield fs.read(fd,buf,0,size,void 0);if(bytesRead!=size)throw new Error("Reached end of file while reading VP8L chunk");return 1&size&&(yield fs.read(fd,discard,0,1,void 0)),{raw:buf,alpha:doesVP8LHaveAlpha(buf,0),width:VP8LWidth(buf),height:VP8LHeight(buf)}}));return function(_x11,_x12){return _readChunk_VP8L3.apply(this,arguments)}}(),_readChunk_VP8L_buf2=function(buf,size,cursor){if(cursor>=buf.length)throw new Error("Reached end of buffer while reading VP8L chunk");let raw=buf.slice(cursor,cursor+size);return{raw:raw,alpha:doesVP8LHaveAlpha(raw),width:VP8LWidth(raw),height:VP8LHeight(raw)}},_readChunk_VP8X2=function(){var _readChunk_VP8X3=_asyncToGenerator((function*(fd,size){let buf=Buffer.alloc(size),{bytesRead:bytesRead}=yield fs.read(fd,buf,0,size,void 0);if(bytesRead!=size)throw new Error("Reached end of file while reading VP8X chunk");return{raw:buf,hasICC:!!(32&buf[0]),hasAlpha:!!(16&buf[0]),hasEXIF:!!(8&buf[0]),hasXMP:!!(4&buf[0]),hasAnim:!!(2&buf[0]),width:buf.readUIntLE(4,3)+1,height:buf.readUIntLE(7,3)+1}}));return function(_x13,_x14){return _readChunk_VP8X3.apply(this,arguments)}}(),_readChunk_ANIM2=function(){var _readChunk_ANIM3=_asyncToGenerator((function*(fd,size){let buf=Buffer.alloc(size),{bytesRead:bytesRead}=yield fs.read(fd,buf,0,size,void 0);if(bytesRead!=size)throw new Error("Reached end of file while reading ANIM chunk");return{raw:buf,bgColor:buf.slice(0,4),loopCount:buf.readUInt16LE(4)}}));return function(_x15,_x16){return _readChunk_ANIM3.apply(this,arguments)}}(),_readChunk_ANMF2=function(){var _readChunk_ANMF3=_asyncToGenerator((function*(fd,size){let buf=Buffer.alloc(size),discard=Buffer.alloc(1),{bytesRead:bytesRead}=yield fs.read(fd,buf,0,size,void 0);if(bytesRead!=size)throw new Error("Reached end of file while reading ANMF chunk");1&size&&(yield fs.read(fd,discard,0,1,void 0));let out={raw:buf,x:buf.readUIntLE(0,3),y:buf.readUIntLE(3,3),width:buf.readUIntLE(6,3)+1,height:buf.readUIntLE(9,3)+1,duration:buf.readUIntLE(12,3),blend:!(2&buf[15]),dispose:!!(1&buf[15])},keepLooping=!0,cursor=16;for(;keepLooping;){let header=_classPrivateMethodGet(this,_readChunkHeader_buf,_readChunkHeader_buf2).call(this,buf,cursor);switch(cursor+=8,header.fourCC){case"VP8 ":out.vp8||(out.type=constants.TYPE_LOSSY,out.vp8=_classPrivateMethodGet(this,_readChunk_VP8_buf,_readChunk_VP8_buf2).call(this,buf,header.size,cursor));break;case"VP8L":out.vp8l||(out.type=constants.TYPE_LOSSLESS,out.vp8l=_classPrivateMethodGet(this,_readChunk_VP8L_buf,_readChunk_VP8L_buf2).call(this,buf,header.size,cursor));break;case"ALPH":out.vp8&&(out.alph=_classPrivateMethodGet(this,_readChunk_ALPH_buf,_readChunk_ALPH_buf2).call(this,buf,header.size,cursor),out.vp8.alpha=!0);break;default:keepLooping=!1}cursor+=header.size+1,1&header.size&&cursor++,cursor>=buf.length&&(keepLooping=!1)}return out}));return function(_x17,_x18){return _readChunk_ANMF3.apply(this,arguments)}}(),_readChunk_ALPH2=function(){var _readChunk_ALPH3=_asyncToGenerator((function*(fd,size){return _classPrivateMethodGet(this,_readChunk_raw,_readChunk_raw2).call(this,"ALPH",fd,size)}));return function(_x19,_x20){return _readChunk_ALPH3.apply(this,arguments)}}(),_readChunk_ALPH_buf2=function(buf,size,cursor){if(cusor>=buf.length)throw new Error("Reached end of buffer while reading ALPH chunk");return{raw:buf.slice(cursor,cursor+size)}},_readChunk_ICCP2=function(){var _readChunk_ICCP3=_asyncToGenerator((function*(fd,size){return _classPrivateMethodGet(this,_readChunk_raw,_readChunk_raw2).call(this,"ICCP",fd,size)}));return function(_x21,_x22){return _readChunk_ICCP3.apply(this,arguments)}}(),_readChunk_EXIF2=function(){var _readChunk_EXIF3=_asyncToGenerator((function*(fd,size){return _classPrivateMethodGet(this,_readChunk_raw,_readChunk_raw2).call(this,"EXIF",fd,size)}));return function(_x23,_x24){return _readChunk_EXIF3.apply(this,arguments)}}(),_readChunk_XMP2=function(){var _readChunk_XMP3=_asyncToGenerator((function*(fd,size){return _classPrivateMethodGet(this,_readChunk_raw,_readChunk_raw2).call(this,"XML",fd,size)}));return function(_x25,_x26){return _readChunk_XMP3.apply(this,arguments)}}(),_readChunk_Skip2=function(){var _readChunk_Skip3=_asyncToGenerator((function*(fd,size){let buf=Buffer.alloc(size),discard=Buffer.alloc(1),{bytesRead:bytesRead}=yield fs.read(fd,buf,0,size,void 0);if(bytesRead!=size)throw new Error("Reached end of file while skipping chunk");1&size&&(yield fs.read(fd,discard,0,1,void 0))}));return function(_x27,_x28){return _readChunk_Skip3.apply(this,arguments)}}(),_read2=function(){var _read3=_asyncToGenerator((function*(path){let fd=yield fs.open(path,"r"),out={},keepLooping=!0,first=!0,{fileSize:fileSize}=yield _classPrivateMethodGet(this,_readHeader,_readHeader2).call(this,fd);for(;keepLooping;){let{fourCC:fourCC,size:size}=yield _classPrivateMethodGet(this,_readChunkHeader,_readChunkHeader2).call(this,fd);switch(fourCC){case"VP8 ":out.vp8?yield _classPrivateMethodGet(this,_readChunk_Skip,_readChunk_Skip2).call(this,fd,size):out.vp8=yield _classPrivateMethodGet(this,_readChunk_VP,_readChunk_VP2).call(this,fd,size),first&&(out.type=constants.TYPE_LOSSY,keepLooping=!1);break;case"VP8L":out.vp8l?yield _classPrivateMethodGet(this,_readChunk_Skip,_readChunk_Skip2).call(this,fd,size):out.vp8l=yield _classPrivateMethodGet(this,_readChunk_VP8L,_readChunk_VP8L2).call(this,fd,size),first&&(out.type=constants.TYPE_LOSSLESS,keepLooping=!1);break;case"VP8X":out.extended?yield _classPrivateMethodGet(this,_readChunk_Skip,_readChunk_Skip2).call(this,fd,size):(out.type=constants.TYPE_EXTENDED,out.extended=yield _classPrivateMethodGet(this,_readChunk_VP8X,_readChunk_VP8X2).call(this,fd,size));break;case"ANIM":if(out.anim)yield _classPrivateMethodGet(this,_readChunk_Skip,_readChunk_Skip2).call(this,fd,size);else{let{raw:raw,bgColor:bgColor,loopCount:loopCount}=yield _classPrivateMethodGet(this,_readChunk_ANIM,_readChunk_ANIM2).call(this,fd,size);out.anim={backgroundColor:[bgColor[2],bgColor[1],bgColor[0],bgColor[3]],loopCount:loopCount,frames:[]},out.anim.raw=raw}break;case"ANMF":{let f=yield _classPrivateMethodGet(this,_readChunk_ANMF,_readChunk_ANMF2).call(this,fd,size);out.anim.frames.push(f)}break;case"ALPH":out.alph?yield _classPrivateMethodGet(this,_readChunk_Skip,_readChunk_Skip2).call(this,fd,size):out.alph=yield _classPrivateMethodGet(this,_readChunk_ALPH,_readChunk_ALPH2).call(this,fd,size);break;case"ICCP":out.iccp?yield _classPrivateMethodGet(this,_readChunk_Skip,_readChunk_Skip2).call(this,fd,size):out.iccp=yield _classPrivateMethodGet(this,_readChunk_ICCP,_readChunk_ICCP2).call(this,fd,size);break;case"EXIF":out.exif?yield _classPrivateMethodGet(this,_readChunk_Skip,_readChunk_Skip2).call(this,fd,size):out.exif=yield _classPrivateMethodGet(this,_readChunk_EXIF,_readChunk_EXIF2).call(this,fd,size);break;case"XMP ":out.xmp?yield _classPrivateMethodGet(this,_readChunk_Skip,_readChunk_Skip2).call(this,fd,size):out.xmp=yield _classPrivateMethodGet(this,_readChunk_XMP,_readChunk_XMP2).call(this,fd,size);break;case"\0\0\0\0":keepLooping=!1;break;default:yield _classPrivateMethodGet(this,_readChunk_Skip,_readChunk_Skip2).call(this,fd,size)}first=!1}return out.type==constants.TYPE_EXTENDED&&out.extended.hasAnim&&(out.anim.frameCount=out.anim.frames.length),out}));return function(_x29){return _read3.apply(this,arguments)}}(),_default={TYPE_LOSSY:constants.TYPE_LOSSY,TYPE_LOSSLESS:constants.TYPE_LOSSLESS,TYPE_EXTENDED:constants.TYPE_EXTENDED,Image:Image};exports.default=_default;